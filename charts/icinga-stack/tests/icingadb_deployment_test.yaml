suite: "[IcingaDB] Deployment"
templates:
  - ../charts/icingadb/templates/deployment.yaml
tests:
  - it: deploys an IcingaDB deployment
    values:
      - required_values.yaml
    release:
      name: my-icinga
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingadb

  - it: deploys an IcingaDB deployment using values
    values:
      - required_values.yaml
    release:
      name: my-icinga
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingadb
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ICINGADB_DATABASE_USER
            value: icingadb
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ICINGADB_DATABASE_PASSWORD
            value: insecureicingadbpassword

  - it: deploys an IcingaDB deployment using secrets
    values:
      - required_values_secrets.yaml
    release:
      name: my-icinga
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingadb
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ICINGADB_DATABASE_USER
            valueFrom:
              secretKeyRef:
                name: database-icingadb
                key: username
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ICINGADB_DATABASE_PASSWORD
            valueFrom:
              secretKeyRef:
                name: database-icingadb
                key: password  

  - it: deploys an IcingaDB deployment with extra env vars
    values:
      - required_values.yaml
    release:
      name: my-icinga
    set:
      icingadb:
        extraEnvVars:
          - name: OTHER_ENV_VAR_FIRST
            value: first
          - name: OTHER_ENV_VAR_SECOND
            value: second
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingadb
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OTHER_ENV_VAR_FIRST
            value: first
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OTHER_ENV_VAR_SECOND
            value: second

  - it: deploys an IcingaDB deployment with extra from config map
    values:
      - required_values.yaml
    release:
      name: my-icinga
    set:
      icingadb:
        extraEnvVarsCM: "my-icinga-icingadb-env"
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingadb
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            configMapRef:
              name: my-icinga-icingadb-env
  
  - it: deploys an IcingaDB deployment with extra from secret
    values:
      - required_values.yaml
    release:
      name: my-icinga
    set:
      icingadb:
        extraEnvVarsSecret: "my-icinga-icingadb-env"
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingadb
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: my-icinga-icingadb-env
  
  - it: deploys an IcingaDB deployment with pgsql database type
    values:
      - required_values.yaml
    release:
      name: my-icinga
    set:
      global:
        databases:
          icingadb:
            username:
              value: icingadb
            password:
              value: insecureicingadbpassword
            type: pgsql
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingadb
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ICINGADB_DATABASE_TYPE
            value: pgsql
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ICINGADB_DATABASE_PORT
            value: "5432"

  - it: fails an IcingaDB deployment with database type other than pgsql or mysql
    values:
      - required_values.yaml
    release:
      name: my-icinga
    set:
      global:
        databases:
          icingadb:
            username:
              value: icingadb
            password:
              value: insecureicingadbpassword
            type: othervalue
    asserts:
      - failedTemplate:
          errorMessage: type should be either mysql (default) or pgsql
