suite: "[Icingaweb2] Deployment"
templates:
  - ../charts/icingaweb2/templates/deployment.yaml
tests:
  - it: deploys an Icingaweb2 deployment with minimal configuration
    values:
      - required_values.yaml
    release:
      name: my-icinga
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingaweb2
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.enabledModules
            value: director,icingadb,incubator,
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.passwords.icingaweb2.icingaweb
            value: insecurepassword

  - it: deploys an Icingaweb2 deployment with additional modules
    values:
      - required_values.yaml
    set:
      icingaweb2:
        auth:
          admin_password:
            value: insecurepassword
        modules:
          x509:
            enabled: true
    release:
      name: my-icinga
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingaweb2
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.enabledModules
            value: director,icingadb,incubator,x509,
          any: true
  
  - it: deploys an Icingaweb2 deployment with minimal configuration using secrets
    values:
      - required_values_secrets.yaml
    release:
      name: my-icinga
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingaweb2
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.enabledModules
            value: director,icingadb,incubator,
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.passwords.icingaweb2.icingaweb
            valueFrom:
              secretKeyRef:
                name: icingaweb2-secret
                key: admin_password

  - it: deploys an Icingaweb2 deployment with graphite
    values:
      - required_values.yaml
    set:
      icingaweb2:
        auth:
          admin_password:
            value: insecurepassword
        modules:
          graphite:
            enabled: true
    release:
      name: my-icinga
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingaweb2
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.enabledModules
            value: director,graphite,icingadb,incubator,
          any: true

  - it: deploys an Icingaweb2 deployment with graphite, user/password from value
    values:
      - required_values.yaml
    set:
      icingaweb2:
        auth:
          admin_password:
            value: insecurepassword
        modules:
          graphite:
            enabled: true
            graphite:
              user:
                value: graphite-user
              password:
                value: graphite-password
    release:
      name: my-icinga
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingaweb2
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.modules.graphite.config.graphite.user
            value: graphite-user
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.modules.graphite.config.graphite.password
            value: graphite-password

  - it: deploys an Icingaweb2 deployment with graphite, user/password from secret
    values:
      - required_values.yaml
    set:
      icingaweb2:
        auth:
          admin_password:
            value: insecurepassword
        modules:
          graphite:
            enabled: true
            graphite:
              credSecret: graphite-secret
              user:
                secretKey: graphite-user
              password:
                secretKey: graphite-password
    release:
      name: my-icinga
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingaweb2
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.modules.graphite.config.graphite.user
            valueFrom:
              secretKeyRef:
                name: graphite-secret
                key: graphite-user
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.modules.graphite.config.graphite.password
            valueFrom:
              secretKeyRef:
                name: graphite-secret
                key: graphite-password

  - it: failed deployment of Icingaweb2 due to partial secret definition
    values:
      - required_values_secrets.yaml
    set:
      global:
        api:
          users:
            credSecret: api-users
            director:
              password:
            icingaweb:
              password:
                secretKey: icingaweb-password
    release:
      name: my-icinga
    asserts:
      - failedTemplate:
          errorMessage: "director api user password not set. Set either .Values.global.api.users.director.password.value or .Values.global.api.users.credSecret and .Values.global.api.users.director.password.secretKey"

  - it: deploys an Icingaweb2 deployment with psql as database type
    values:
      - required_values.yaml
    release:
      name: my-icinga
    set:
      icingaweb2:
        auth:
          admin_password:
            value: insecurepassword
        modules:
          x509:
            enabled: true
      global:
        api:
          users:
            director:
              password:
                value: director-insecurepassword
            icingaweb:
              password:
                value: icingaweb-insecurepassword
        databases:
          director:
            username:
              value: director
            password:
              value: insecuredirectorpassword
            type: pgsql
          icingadb:
            username:
              value: icingadb
            password:
              value: insecureicingadbpassword
            type: pgsql
          icingaweb2:
            username:
              value: icingaweb2
            password:
              value: insecureicingaweb2password
            type: pgsql
          x509:
            username:
              value: icingax509
            password:
              value: insecureicingax509password
            type: pgsql
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingaweb2
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.resources.directordb.db
            value: pgsql
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.resources.icingadb.db
            value: pgsql
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.resources.icingaweb2db.db
            value: pgsql
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.resources.x509db.db
            value: pgsql
  
  - it: fails an Icingaweb2 deployment with database type other than pgsql or mysql
    values:
      - required_values.yaml
    release:
      name: my-icinga
    set:
      icingaweb2:
        auth:
          admin_password:
            value: insecurepassword
        modules:
          x509:
            enabled: true
      global:
        api:
          users:
            director:
              password:
                value: director-insecurepassword
            icingaweb:
              password:
                value: icingaweb-insecurepassword
        databases:
          icingaweb2:
            username:
              value: icingaweb2
            password:
              value: insecureicingaweb2password
            type: othervalue
    asserts:
      - failedTemplate:
          errorMessage: type should be either mysql (default) or pgsql

  - it: deploys an Icingaweb2 deployment with psql as database type
    values:
      - required_values.yaml
    release:
      name: my-icinga
    set:
      icingaweb2:
        auth:
          admin_password:
            value: insecurepassword
        modules:
          x509:
            enabled: true
      global:
        api:
          users:
            director:
              password:
                value: director-insecurepassword
            icingaweb:
              password:
                value: icingaweb-insecurepassword
        databases:
          director:
            username:
              value: director
            password:
              value: insecuredirectorpassword
            type: pgsql
          icingadb:
            username:
              value: icingadb
            password:
              value: insecureicingadbpassword
            type: pgsql
          icingaweb2:
            username:
              value: icingaweb2
            password:
              value: insecureicingaweb2password
            type: pgsql
          x509:
            username:
              value: icingax509
            password:
              value: insecureicingax509password
            type: pgsql
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingaweb2
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.resources.directordb.db
            value: pgsql
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.resources.icingadb.db
            value: pgsql
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.resources.icingaweb2db.db
            value: pgsql
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: icingaweb.resources.x509db.db
            value: pgsql
  
  - it: fails an Icingaweb2 deployment with database type other than pgsql or mysql
    values:
      - required_values.yaml
    release:
      name: my-icinga
    set:
      icingaweb2:
        auth:
          admin_password:
            value: insecurepassword
        modules:
          x509:
            enabled: true
      global:
        api:
          users:
            director:
              password:
                value: director-insecurepassword
            icingaweb:
              password:
                value: icingaweb-insecurepassword
        databases:
          icingaweb2:
            username:
              value: icingaweb2
            password:
              value: insecureicingaweb2password
            type: othervalue
    asserts:
      - failedTemplate:
          errorMessage: type should be either mysql (default) or pgsql

  - it: deploys an Icingaweb2 deployment with extra env vars
    values:
      - required_values.yaml
    release:
      name: my-icinga
    set:
      icingaweb2:
        auth:
          admin_password:
            value: insecurepassword
        extraEnvVars:
          - name: OTHER_ENV_VAR_FIRST
            value: first
          - name: OTHER_ENV_VAR_SECOND
            value: second
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingaweb2
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OTHER_ENV_VAR_FIRST
            value: first
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OTHER_ENV_VAR_SECOND
            value: second

  - it: deploys an Icingaweb2 deployment with extra from config map
    values:
      - required_values.yaml
    release:
      name: my-icinga
    set:
      icingaweb2:
        auth:
          admin_password:
            value: insecurepassword
        extraEnvVarsCM: "my-icinga-icingaweb2-env"
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingaweb2
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            configMapRef:
              name: my-icinga-icingaweb2-env
  
  - it: deploys an Icingaweb2 deployment with extra from secret
    values:
      - required_values.yaml
    release:
      name: my-icinga
    set:
      icingaweb2:
        auth:
          admin_password:
            value: insecurepassword
        extraEnvVarsSecret: "my-icinga-icingaweb2-env"
    asserts:
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
      - equal:
          path: metadata.name
          value: my-icinga-icingaweb2
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: my-icinga-icingaweb2-env